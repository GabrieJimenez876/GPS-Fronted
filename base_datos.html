<!DOCTYPE html>
<html lang="es">
<head>
Â  <meta charset="utf-8"/>
Â  <meta name="viewport" content="width=device-width, initial-scale=1"/>
Â  <title>Base de Datos â€” GPS Transporte La Paz</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous"/>
Â    <style>
    :root{ --c-primary:#004d40; --c-bg:#f6f7f8; --c-fg:#1f2937; --c-panel:#ffffff; --c-border:#e5e7eb; --radius:12px; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--c-bg);color:var(--c-fg)}
    header{position:sticky;top:0;z-index:20;background:var(--c-primary);color:#fff}
    .header-inner{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:36px;height:36px;border-radius:50%;background:#00a58c;display:grid;place-items:center;font-weight:700}
    .brand h1{font-size:18px;margin:0}
    nav{flex:1;display:flex;justify-content:center}
    .menu{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{height:42px;padding:0 14px;border:1px solid #9ee7db;border-radius:8px;background:#e6fffa;color:#083b35;cursor:pointer}
    .btn.primary{background:#00a58c;color:#fff;border-color:#00a58c}
    .menu-item{position:relative}
    .dropdown{position:absolute;top:calc(100% + 6px);left:0;min-width:240px;background:#fff;border:1px solid var(--c-border);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.08);display:none;padding:6px;z-index:30}
    .dropdown a{display:block;padding:10px 12px;border-radius:8px;color:#111;text-decoration:none}
    .dropdown a:hover{background:#f3f4f6}
    .menu-item:hover .dropdown{display:block}
    .profile-area{display:flex;align-items:center;gap:10px}
    .container{max-width:1200px;margin:0 auto;padding:14px;display:grid;gap:14px}
    .panel{background:var(--c-panel);border:1px solid var(--c-border);border-radius:var(--radius);box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .panel header{padding:12px 14px;border-bottom:1px solid var(--c-border)}
    .panel .content{padding:12px 14px}
    footer{background:var(--c-primary);color:#fff;margin-top:14px}
    .footer-inner{max-width:1200px;margin:0 auto;padding:14px;display:grid;gap:10px}
    .socials{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .socials a{display:inline-flex;align-items:center;gap:6px;background:#00695c;color:#fff;text-decoration:none;padding:4px 8px;border-radius:8px}
    .socials svg{width:16px;height:16px;fill:#fff}
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:min(520px,92vw);background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .modal header{background:#00a58c;color:#fff;padding:12px 16px}
    .modal .content{padding:16px;display:grid;gap:10px}
    .modal .footer{padding:12px 16px;display:flex;justify-content:flex-end;gap:10px;border-top:1px solid #eee}
    input[type="text"],input[type="email"],input[type="password"]{height:42px;padding:0 12px;border:1px solid var(--c-border);border-radius:8px}
    .dark body{background:#121212;color:#e6e6e6}
  </style>
	</style>
  <style>
    /* Ensure header/menu and dropdowns render above maps */
    .header-inner, .menu, .menu .btn, .profile-area, .dropdown { position: relative; z-index: 1100; }
    .dropdown { z-index: 1110; }
    #map, .map-box { position: relative; z-index: 0; }
    .backdrop, .modal-backdrop { z-index: 1200; }

    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .card{background:var(--c-panel);border:1px solid var(--c-border);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);cursor:pointer}
    .card:hover{transform:translateY(-1px)}
    .card h3{margin:0 0 6px 0}
    .card p{margin:0;color:#374151}
    <footer>
      <div class="footer-inner">
        <div>Contacto: <a href="mailto:lapazbus@lapaz.bo" style="color:#b2fff5">lapazbus@lapaz.bo</a> â€” Tel: 2652444</div>
        <div style="opacity:.9;font-size:13px">GPS Transporte â€” La Paz</div>
      </div>
    </footer>
    }
    .table tbody tr:hover {
      background: #f8fafc;
    }
    .table tbody tr:last-child td {
      border-bottom: none;
    }
    .table .btn {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 6px;
      margin: 0 4px;
    }
    .table .btn.danger {
      border-color: #dc2626;
      color: #dc2626;
    }
    .table .btn.danger:hover {
      background: #fef2f2;
    }
    @media (max-width:980px) {
      .grid { grid-template-columns: 1fr }
      .table .btn { margin-bottom: 4px; display: block; text-align: left; }
    }
  </style>
  <style>
    /* database styles */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }
    .search-box {
      position: relative;
      flex: 1;
    }
    .search-box i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #6b7280;
    }
    .search-box input {
      width: 100%;
      padding: 10px 12px 10px 36px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: white;
      font-size: 14px;
    }
    .search-box input:focus {
      outline: none;
      border-color: var(--c-primary);
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    }
    .actions {
      display: flex;
      gap: 8px;
    }
    .table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .table th {
      background: #f8fafc;
      padding: 12px 16px;
      text-align: left;
      font-weight: 500;
      color: #1f2937;
      font-size: 14px;
      border-bottom: 1px solid #f1f5f9;
    }
    .table td {
      padding: 12px 16px;
      border-bottom: 1px solid #f1f5f9;
      color: #4b5563;
      font-size: 14px;
      vertical-align: middle;
    }
    .table tbody tr:hover {
      background: #f8fafc;
    }
    .table tbody tr:last-child td {
      border-bottom: none;
    }
    .table .btn {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 6px;
      margin: 0 4px;
    }
    .table .btn.danger {
      border-color: #dc2626;
      color: #dc2626;
    }
    .table .btn.danger:hover {
      background: #fef2f2;
    }
    @media (max-width:980px) {
      .grid { grid-template-columns: 1fr }
      .table .btn { margin-bottom: 4px; display: block; text-align: left; }
    }

    /* nav compatibility */
    .nav-row { display:flex; gap:8px; align-items:center; width:100%; }
    .nav-left { display:flex; gap:8px; align-items:center; }
    .nav-right { margin-left:auto; display:flex; gap:8px; }
    .nav-btn{ height:42px; padding:0 12px; display:inline-flex; gap:8px; align-items:center; border-radius:8px; background:rgba(255,255,255,0.95); color:var(--c-primary); border:1px solid rgba(255,255,255,0.08); cursor:pointer; font-size:14px; }
    .nav-btn.primary{ background:var(--c-primary); color:#fff; border-color:var(--c-primary); }
    .nav-btn .fa{ font-size:16px; }
  </style>
  <!-- Shared styles and scripts -->
  <link rel="stylesheet" href="/assets/shared.css" />
  <script src="/assets/shared.js"></script>
</head>
<body>
Â  
	<header>
		<div class="header-inner">
			<!-- Brand -->
			<div class="brand">
				<div class="logo" aria-hidden="true">LP</div>
				<div>
					<h1 id="appTitle">GPS Transporte â€” La Paz</h1>
					<div style="font-size:12px; opacity:.9">Centro de transporte comunitario</div>
				</div>
			</div>

			<!-- Navigation -->
			<nav class="nav-row">
				<div class="nav-left">
					<div class="menu-item">
						<button class="nav-btn" id="btnRoutes">
							<i class="fa fa-location-dot"></i>
							<span>Rutas</span>
						</button>
						<div class="dropdown">
							<a href="rutas/linea-1.html">LÃ­nea 1 â€” Villa FÃ¡tima â‡„ Miraflores</a>
							<a href="rutas/linea-2.html">LÃ­nea 2 â€” Ceja â‡„ Cementerio</a>
							<a href="rutas/linea-3.html">LÃ­nea 3 â€” Terminal â‡„ TelefÃ©rico Central</a>
							<a href="ver_rutas.html"><strong>Ver todas las rutas â†’</strong></a>
						</div>
					</div>

					<button class="nav-btn" id="btnGuide">
						<i class="fa fa-book"></i>
						<span>GuÃ­a</span>
					</button>
          
					<button class="nav-btn" id="btnDark">
						<i class="fa fa-moon"></i>
						<span>Modo</span>
					</button>
          
					<button class="nav-btn" id="btnLang">
						<i class="fa fa-language"></i>
						<span>English</span>
					</button>
				</div>

				<div class="nav-right">
					<!-- Admin button (hidden by default) -->
					<div class="menu-item" id="adminSection" style="display:none">
						<button class="nav-btn">
							<i class="fa fa-wrench"></i>
							<span>Admin</span>
						</button>
						<div class="dropdown">
							<a href="agregar_linea.html">â• Agregar lÃ­nea</a>
							<a href="base_datos.html">ğŸ“„ Ver base de datos</a>
							<a href="sindicatos.html">ğŸ¤ Sindicatos</a>
						</div>
					</div>

					<div id="userArea">
						<!-- visible when no session -->
						<button class="nav-btn" id="btnRegister">
							<i class="fa fa-user-plus"></i>
							<span>Registrarse</span>
						</button>

						<button class="nav-btn primary" id="btnLogin">
							<i class="fa fa-user"></i>
							<span>Iniciar sesiÃ³n</span>
						</button>

						<!-- profile pill (hidden by default) -->
						<div class="menu-item profile-wrap" id="profileWrap" style="display:none;">
							<button class="nav-btn" id="btnProfile">
								<span id="profileAvatar" style="display:inline-grid;place-items:center;width:30px;height:30px;border-radius:50%;background:#fff;color:var(--primary);font-weight:600;margin-right:8px;">A</span>
								<div style="text-align:left;line-height:1;">
									<div id="profileName" style="font-size:13px;color:#fff;font-weight:600">User</div>
									<div id="profileEmail" style="font-size:11px;opacity:0.9;color:#eafaf7">email@example.com</div>
								</div>
							</button>
							<div class="dropdown" id="profileDropdown">
								<a href="#" id="btnSwitchUser">Cambiar usuario</a>
								<a href="#" id="btnLogout">Cerrar sesiÃ³n</a>
							</div>
						</div>
					</div>
				</div>
			</nav>
		</div>
	</header>

  <main class="container">
    <section>
      <div style="display:flex;align-items:center;justify-content:space-between;margin:0 0 10px 0">
        <h2 style="margin:0">Base de datos</h2>
        <button class="nav-btn primary" id="btnCreate">
          <i class="fa fa-plus"></i>
          <span>Agregar lÃ­nea</span>
        </button>
      </div>

      <div class="panel">
        <div class="content">
          <div class="toolbar">
            <div class="search-box">
              <i class="fa fa-search"></i>
              <input type="text" id="search" placeholder="Buscar por ruta, operador o vehÃ­culo..."/>
            </div>
            <div class="actions">
              <button class="nav-btn" id="btnExport">
                <i class="fa fa-download"></i>
                <span>Exportar</span>
              </button>
              <label class="nav-btn" for="fileImport" style="cursor:pointer">
                <i class="fa fa-upload"></i>
                <span>Importar</span>
              </label>
            </div>
            <input type="file" id="fileImport" accept="application/json" style="display:none"/>
          </div>
          <div style="overflow:auto">
            <table class="table" id="dbTable">
              <thead>
                <tr>
                  <th style="width:56px">ID</th>
                  <th>Ruta</th>
                  <th>Operador</th>
                  <th>VehÃ­culo</th>
                  <th style="width:280px;text-align:right">Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <p style="margin-top:8px;color:#374151;font-size:13px" id="dbStatus">
            <i class="fa fa-info-circle"></i>
            Los datos son almacenados localmente en el navegador.
          </p>
        </div>
      </div>
    </section>
  </main>Â  <footer>
Â  Â  <div class="footer-inner">
Â  Â  Â  <div>Contacto: <a href="mailto:lapazbus@lapaz.bo" style="color:#b2fff5">lapazbus@lapaz.bo</a> â€” Tel: 2652444 / 61022444</div>
Â  Â  Â  <div class="socials" aria-label="redes sociales">
Â  Â  Â  Â  <a href="#" title="Facebook" aria-label="Facebook">
Â  Â  Â  Â  Â  <svg viewBox="0 0 24 24"><path d="M22 12.07C22 6.48 17.52 2 11.93 2S2 6.48 2 12.07C2 17.08 5.66 21.2 10.44 22v-7.01H7.9v-2.92h2.54V9.84c0-2.5 1.49-3.89 3.77-3.89 1.09 0 2.24.2 2.24.2v2.47h-1.26c-1.24 0-1.63.77-1.63 1.56v1.87h2.78l-.44 2.92h-2.34V22C18.34 21.2 22 17.08 22 12.07z"></path></svg>
Â  Â  Â  Â  Â  <span>Facebook</span>
Â  Â  Â  Â  </a>
Â  Â  Â  Â  <a href="#" title="X/Twitter" aria-label="X/Twitter">
Â  Â  Â  Â  Â  <svg viewBox="0 0 24 24"><path d="M3 3h5.3l4.1 6.2L16.7 3H21l-7.2 10.2L21 21h-5.3l-4.2-6.1L7.3 21H3l7.8-10.8L3 3z"></path></svg>
Â  Â  Â  Â  Â  <span>Twitter</span>
Â  Â  Â  Â  </a>
Â  Â  Â  Â  <a href="#" title="Instagram" aria-label="Instagram">
Â  Â  Â  Â  Â  <svg viewBox="0 0 24 24"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm5 3.5A5.5 5.5 0 1 1 6.5 13 5.5 5.5 0 0 1 12 7.5zm6.75-1.5a1.25 1.25 0 1 1-1.25 1.25A1.25 1.25 0 0 1 18.75 6z"></path></svg>
Â  Â  Â  Â  Â  <span>Instagram</span>
Â  Â  Â  Â  </a>
Â  Â  Â  Â  <a href="#" title="Telegram" aria-label="Telegram">
Â  Â  Â  Â  Â  <svg viewBox="0 0 24 24"><path d="M9.04 15.47 8.8 19.7a.94.94 0 0 0 .73-.35l1.75-1.67 3.63 2.67c.67.37 1.15.18 1.33-.62l2.42-11.34c.21-.93-.34-1.3-1-1.07L3.95 11.1c-.9.35-.89.84-.16 1.07l3.6 1.12 8.38-5.29c.39-.24.75-.11.46.15l-7.19 6.32z"></path></svg>
Â  Â  Â  Â  Â  <span>Telegram</span>
Â  Â  Â  Â  </a>
Â  Â  Â  </div>
Â  Â  </div>
Â  </footer>

  <!-- Modal para ver paradas y ruta -->
  <div class="backdrop" id="viewBackdrop" role="dialog" aria-modal="true" style="display:none">
    <div class="modal" style="width:90%;max-width:900px">
      <header><h3 id="viewTitle" style="margin:0">Ver Ruta</h3></header>
      <div class="content">
        <div id="viewMap" style="height:320px;border-radius:8px"></div>
        <div id="viewStopsList" style="margin-top:8px"></div>
      </div>
      <div class="footer">
        <button class="btn" id="btnCloseView">Cerrar</button>
      </div>
    </div>
  </div>
  <!-- Background map behind content -->
  <div id="bgMap"></div>

Â  Â  <div class="backdrop" id="loginBackdrop" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
Â  Â  <div class="modal">
Â  Â  Â  <header><h3 id="loginTitle" style="margin:0">Iniciar sesiÃ³n</h3></header>
Â  Â  Â  <div class="content">
Â  Â  Â  Â  <label for="email">Correo</label>
Â  Â  Â  Â  <input type="email" id="email" placeholder="usuario@gmail.com"/>
Â  Â  Â  Â  <label for="password">ContraseÃ±a</label>
Â  Â  Â  Â  <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
Â  Â  Â  </div>
Â  Â  Â  <div class="footer">
Â  Â  Â  Â  <button class="btn" id="btnCloseLogin">Cerrar</button>
Â  Â  Â  Â  <button class="btn primary" id="btnDoLogin">Ingresar</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
Â  <div class="backdrop" id="guideBackdrop" role="dialog" aria-modal="true" aria-labelledby="guideTitle">
Â  Â  <div class="modal">
Â  Â  Â  <header><h3 id="guideTitle" style="margin:0">GuÃ­a rÃ¡pida</h3></header>
Â  Â  Â  <div class="content"><p>Explora las rutas, administra datos y consulta sindicatos.</p></div>
Â  Â  Â  <div class="footer"><button class="btn primary" id="btnCloseGuide">Entendido</button></div>
Â  Â  </div>
Â  </div>

Â  Â  <div class="backdrop" id="routeModalBackdrop" role="dialog" aria-modal="true" aria-labelledby="routeModalTitle">
Â  Â  <div class="modal">
Â  Â  Â  <header><h3 id="routeModalTitle" style="margin:0">Crear/Editar Ruta</h3></header>
Â  Â  Â  <div class="content">
Â  Â  Â  Â  <input type="hidden" id="routeId"/>
Â  Â  Â  Â  <label for="routeName">Nombre de la Ruta (ej: "Caja Ferroviaria")</label>
Â  Â  Â  Â  <input type="text" id="routeName" placeholder="Nombre de la Ruta" required/>
Â  Â  Â  Â  <label for="routeOperator">Operador/Sindicato (ej: "Sindicato Murillo")</label>
Â  Â  Â  Â  <input type="text" id="routeOperator" placeholder="Operador/Sindicato" required/>
Â  Â  Â  Â  <label for="routeVehicle">Tipo de VehÃ­culo (ej: "Microbus NÂ° 45")</label>
Â  Â  Â  Â  <input type="text" id="routeVehicle" placeholder="Tipo de VehÃ­culo" required/>
Â  Â  Â  </div>
Â  Â  Â  <div class="footer">
Â  Â  Â  Â  <button class="btn" id="btnCloseRouteModal">Cancelar</button>
Â  Â  Â  Â  <button class="btn primary" id="btnSaveRoute">Guardar</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

  <script>
    // Dynamically load Leaflet JS if not already loaded and render a modal map for a route
    function loadLeaflet() {
      return new Promise((resolve, reject) => {
        if (window.L) return resolve(window.L);
        const s = document.createElement('script');
        s.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
        s.integrity = 'sha256-o9N1j7kQb6v6g2a2bY1s5Qxjv5Q5g3pJZ+0s1m0s+3s=';
        s.crossOrigin = '';
        s.onload = () => resolve(window.L);
        s.onerror = () => reject(new Error('Leaflet failed to load'));
        document.head.appendChild(s);
      });
    }

    let __viewMap = null;
    window.viewRoute = async function(id) {
      let route = DATA.find(r => r.id === id);
      if (!route) {
        try {
          const res = await fetch(`${API}/api/lineas`);
          const all = await res.json();
          route = all.find(r => r.id === id);
        } catch(e) { console.error(e); }
      }
      if (!route) { alert('Ruta no encontrada'); return; }
      document.getElementById('viewTitle').textContent = route.nombre || route.name || 'Ruta';
      const paradas = route.paradas || [];
      document.getElementById('viewStopsList').innerHTML = paradas.length ? '<ol>'+ paradas.map(p=>`<li>${p.nombre||p.name||''} â€” ${p.lat||p.latitude||p.lat}, ${p.lng||p.lng||p.lon||p.longitude||''}</li>`).join('') + '</ol>' : '<div style="color:#666">No hay paradas registradas.</div>';
      document.getElementById('viewBackdrop').style.display = 'flex';
      try {
        await loadLeaflet();
        if (__viewMap) { __viewMap.remove(); __viewMap = null; }
        const mapEl = document.getElementById('viewMap');
        mapEl.innerHTML = '';
        const center = paradas.length ? [parseFloat(paradas[0].lat), parseFloat(paradas[0].lng)] : [ -16.5, -68.15 ];
        __viewMap = L.map('viewMap').setView(center, paradas.length ? 14 : 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(__viewMap);
        const latlngs = [];
        paradas.forEach(p => {
          const lat = parseFloat(p.lat || p.latitude || p.latitud || 0);
          const lng = parseFloat(p.lng || p.longitude || p.lon || p.lng || 0);
          if (!isFinite(lat) || !isFinite(lng)) return;
          latlngs.push([lat, lng]);
          L.marker([lat, lng]).addTo(__viewMap).bindPopup((p.nombre||p.name||'Parada') + '<br/>' + (p.descripcion||''));
        });
        if (latlngs.length) {
          // Draw route in blue, 4px thick as requested
          L.polyline(latlngs, { color: 'blue', weight: 4 }).addTo(__viewMap);
          __viewMap.fitBounds(latlngs, { padding: [20,20] });
        }
      } catch (err) { console.error('Error cargando Leaflet', err); }
    };

    document.getElementById('btnCloseView').addEventListener('click', ()=> {
      document.getElementById('viewBackdrop').style.display = 'none';
      if (__viewMap) { __viewMap.remove(); __viewMap = null; }
    });
  </script>
  <script>
    // Shared helper to select elements
    const $ = s => document.querySelector(s);
    const API = window.location.origin; // serve from same origin

    // --- Data via server API ---
    async function loadRoutes() {
      try {
        const res = await fetch(`${API}/api/lineas`);
        if (!res.ok) return [];
        const json = await res.json();
        // Normalize fields for UI
        return json.map(l => ({
          id: l.id,
          key: l.codigo || ('R' + String(l.id).padStart(2, '0')),
          name: l.nombre || l.name || l.ruta || '',
          operator: l.sindicato || l.operator || '',
          vehicle: l.vehicle || l.vehiculo || ''
        }));
      } catch (e) {
        console.error('Error loading routes from API', e);
        return [];
      }
    }

    async function createRoute(newRoute) {
      // Map UI fields to API shape
      const payload = { nombre: newRoute.name, codigo: newRoute.key || '', sindicato: newRoute.operator, paradas: [] };
      const res = await fetch(`${API}/api/lineas`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('Error creando ruta');
      return await loadAndRender();
    }

    async function updateRoute(updatedRoute) {
      const payload = { nombre: updatedRoute.name, codigo: updatedRoute.key || '', sindicato: updatedRoute.operator, paradas: [] };
      const res = await fetch(`${API}/api/lineas/${updatedRoute.id}`, {
        method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('Error actualizando ruta');
      return await loadAndRender();
    }

    async function deleteRoute(id) {
      const res = await fetch(`${API}/api/lineas/${id}`, { method: 'DELETE' });
      if (!res.ok) throw new Error('Error eliminando ruta');
      return await loadAndRender();
    }

    function renderTable(rows) {
      const tbody = document.querySelector('#dbTable tbody'); tbody.innerHTML = '';
      if (!rows.length) { tbody.innerHTML = '<tr><td colspan="5">No hay rutas registradas.</td></tr>'; return; }
      rows.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.id || ''}</td><td>${row.name || row.ruta || row.key}</td><td>${row.operator || row.operador || 'â€”'}</td><td>${row.vehicle || row.vehiculo || 'â€”'}</td>
                          <td>
                            <button class="btn" onclick="viewRoute(${row.id})" style="padding: 6px 10px;">ğŸ‘ï¸â€ğŸ—¨ Ver</button>
                            <button class="btn" onclick="editRoute(${row.id})" style="padding: 6px 10px;">âœï¸ Editar</button>
                            <button class="btn danger" onclick="confirmDelete(${row.id})" style="padding: 6px 10px;">ğŸ—‘ï¸ Eliminar</button>
                          </td>`;
        tbody.appendChild(tr);
      });
    }

    // Load and render
    async function loadAndRender() {
      DATA = await loadRoutes();
      renderTable(DATA);
      return DATA;
    }

    // Variables globales y carga inicial
    let DATA = [];
    loadAndRender().catch(e => console.error(e));

Â  Â  // --- LÃ³gica de la interfaz de usuario y eventos ---

Â  Â  // BÃºsqueda
Â  Â  document.getElementById('search').addEventListener('input', e=>{
Â  Â  Â  const q = e.target.value.toLowerCase();
Â  Â  Â  const rows = DATA.filter(r=> 
Â  Â  Â  Â  (r.name||r.ruta||'').toLowerCase().includes(q) || 
Â  Â  Â  Â  (r.operator||r.operador||'').toLowerCase().includes(q) || 
Â  Â  Â  Â  (r.vehicle||r.vehiculo||'').toLowerCase().includes(q)
Â  Â  Â  );
Â  Â  Â  renderTable(rows);
Â  Â  });
Â  Â  
Â  Â  // Exportar
Â  Â  document.getElementById('btnExport').addEventListener('click', ()=>{
Â  Â  Â  const blob = new Blob([JSON.stringify(DATA, null, 2)], {type:'application/json'});
Â  Â  Â  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'base_datos.json';
Â  Â  Â  document.body.appendChild(a); a.click(); document.body.removeChild(a);
Â  Â  });
Â  Â  
Â  Â  // Importar
Â  Â  document.getElementById('fileImport').addEventListener('change', async e=>{
Â  Â  Â  const f = e.target.files[0]; if(!f) return; const text = await f.text();
Â  Â  Â  try{ 
Â  Â  Â  Â  const json = JSON.parse(text); 
Â  Â  Â  Â  if(Array.isArray(json)){ 
Â  Â  Â  Â  Â  DATA = json; 
Â  Â  Â  Â  Â  saveRoutes(DATA); 
Â  Â  Â  Â  Â  renderTable(DATA); 
Â  Â  Â  Â  Â  alert('Importado con Ã©xito'); 
Â  Â  Â  Â  } else alert('JSON invÃ¡lido'); 
Â  Â  Â  }
Â  Â  Â  catch(err){ alert('No se pudo leer el JSON'); }
Â  Â  });

Â  Â  // Funciones del modal Crear/Editar

Â  Â  const routeModalBackdrop = document.getElementById('routeModalBackdrop');
Â  Â  const routeModalTitle = document.getElementById('routeModalTitle');
Â  Â  const btnCloseRouteModal = document.getElementById('btnCloseRouteModal');
Â  Â  const btnSaveRoute = document.getElementById('btnSaveRoute');
Â  Â  
Â  Â  const routeIdInput = document.getElementById('routeId');
Â  Â  const routeNameInput = document.getElementById('routeName');
Â  Â  const routeOperatorInput = document.getElementById('routeOperator');
Â  Â  const routeVehicleInput = document.getElementById('routeVehicle');
Â  Â  
Â  Â  function openRouteModal(mode = 'create', route = {}) {
Â  Â  Â  if (mode === 'create') {
Â  Â  Â  Â  routeModalTitle.textContent = 'â• Crear nueva ruta';
Â  Â  Â  Â  routeIdInput.value = '';
Â  Â  Â  Â  routeNameInput.value = '';
Â  Â  Â  Â  routeOperatorInput.value = '';
Â  Â  Â  Â  routeVehicleInput.value = '';
Â  Â  Â  } else {
Â  Â  Â  Â  routeModalTitle.textContent = `âœï¸ Editar Ruta ID: ${route.id}`;
Â  Â  Â  Â  routeIdInput.value = route.id;
Â  Â  Â  Â  routeNameInput.value = route.name || route.ruta || '';
Â  Â  Â  Â  routeOperatorInput.value = route.operator || route.operador || '';
Â  Â  Â  Â  routeVehicleInput.value = route.vehicle || route.vehiculo || '';
Â  Â  Â  }
Â  Â  Â  routeModalBackdrop.style.display = 'flex';
Â  Â  }

Â  Â  window.editRoute = (id) => {
Â  Â  Â  const route = DATA.find(r => r.id === id);
Â  Â  Â  if (route) openRouteModal('edit', route);
Â  Â  Â  else alert('Ruta no encontrada');
Â  Â  };
Â  Â  
Â  Â  window.confirmDelete = (id) => {
Â  Â  Â  if (confirm(`Â¿EstÃ¡s seguro de que quieres eliminar la Ruta ID ${id}?`)) {
Â  Â  Â  Â  deleteRoute(id);
Â  Â  Â  }
Â  Â  };
Â  Â  
Â  Â  document.getElementById('btnCreate').addEventListener('click', () => openRouteModal('create'));
Â  Â  btnCloseRouteModal.addEventListener('click', () => routeModalBackdrop.style.display = 'none');
Â  Â  
Â  Â  btnSaveRoute.addEventListener('click', () => {
Â  Â  Â  const id = routeIdInput.value ? parseInt(routeIdInput.value) : null;
Â  Â  Â  const routeData = {
Â  Â  Â  Â  id,
Â  Â  Â  Â  name: routeNameInput.value.trim(),
Â  Â  Â  Â  operator: routeOperatorInput.value.trim(),
Â  Â  Â  Â  vehicle: routeVehicleInput.value.trim()
Â  Â  Â  };
Â  Â  Â  
Â  Â  Â  if (!routeData.name || !routeData.operator || !routeData.vehicle) {
Â  Â  Â  Â  alert('Por favor, completa todos los campos.');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  if (id) updateRoute(routeData);
Â  Â  Â  else createRoute(routeData);
Â  Â  Â  
Â  Â  Â  routeModalBackdrop.style.display = 'none';
Â  Â  });
Â  </script>

Â  Â  <script>
Â  Â  (function(){
Â  Â  Â  const USERS_KEY = 'gps_users';
Â  Â  Â  const CURRENT_USER_KEY = 'gps_current_user';
Â  Â  Â  const ADMIN_EMAIL = 'admin@admin.com';
Â  Â  Â  const ADMIN_PASSWORD = 'admin123';

Â  Â  Â  function getUsers(){ try{ return JSON.parse(localStorage.getItem(USERS_KEY)||'[]'); }catch(e){return[]} }
Â  Â  Â  function setCurrent(user){ localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(user)); updateUIForSession(user); }
Â  Â  Â  function getCurrent(){ try{ return JSON.parse(localStorage.getItem(CURRENT_USER_KEY)||'null'); }catch(e){return null} }

Â  Â  Â  function ensureProfileWrap(){ let wrap = document.getElementById('profileWrap'); if(!wrap){ const area = document.querySelector('.profile-area'); if(area){ wrap = document.createElement('div'); wrap.id='profileWrap'; area.appendChild(wrap); } } return wrap; }

Â  Â  Â  function updateUIForSession(session){ const wrap = ensureProfileWrap(); if(!wrap) return; wrap.innerHTML=''; if(!session){ wrap.innerHTML = '<button class="btn primary" id="btnLogin">ğŸ” Iniciar sesiÃ³n</button>'; const btnLogin = document.getElementById('btnLogin'); if(btnLogin) btnLogin.addEventListener('click', ()=> document.getElementById('loginBackdrop').style.display='flex'); }
Â  Â  Â  Â  else { const isAdmin = session.role==='admin'; wrap.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div style="font-weight:700">${session.name||session.email}</div><div style="font-size:12px;color:#eef">${isAdmin? 'Administrador':'Usuario'}</div><button class="btn" id="btnLogout">Salir</button></div>`; const btnLogout = document.getElementById('btnLogout'); if(btnLogout) btnLogout.addEventListener('click', ()=>{ localStorage.removeItem(CURRENT_USER_KEY); updateUIForSession(null); }); }
Â  Â  Â  }

Â  Â  Â  window.addEventListener('DOMContentLoaded', ()=>{
Â  Â  Â  Â  const btnDoLogin = document.getElementById('btnDoLogin');
Â  Â  Â  Â  if(btnDoLogin){ btnDoLogin.addEventListener('click', ()=>{
Â  Â  Â  Â  Â  const email = (document.getElementById('email')||{}).value || 'user@example.com';
Â  Â  Â  Â  Â  const pass = (document.getElementById('password')||{}).value || '';
Â  Â  Â  Â  Â  if(email === ADMIN_EMAIL && pass === ADMIN_PASSWORD){ const admin = { name:'Administrador', email:ADMIN_EMAIL, role:'admin'}; setCurrent(admin); alert('SesiÃ³n iniciada: Admin'); }
Â  Â  Â  Â  Â  else { const user = { name: email.split('@')[0], email, role:'user'}; setCurrent(user); alert('SesiÃ³n iniciada: ' + user.name); }
Â  Â  Â  Â  Â  document.getElementById('loginBackdrop').style.display='none';
Â  Â  Â  Â  }); }
Â  Â  Â  Â  updateUIForSession(getCurrent());
Â  Â  Â  });
Â  Â  })();
Â  </script>

Â  Â  <script>
Â  Â  window.addEventListener('DOMContentLoaded', ()=>{
Â  Â  Â  const btnDark = document.getElementById('btnDark');
Â  Â  Â  if(btnDark) btnDark.addEventListener('click', ()=> document.documentElement.classList.toggle('dark'));
Â  Â  Â  const btnLang = document.getElementById('btnLang');
Â  Â  Â  if(btnLang){ let lang='es'; btnLang.addEventListener('click', ()=>{ lang=(lang==='es')?'en':'es'; btnLang.textContent=(lang==='es')?'ğŸŒ English':'ğŸŒ EspaÃ±ol'; const h1=document.querySelector('h1'); if(h1) h1.textContent=(lang==='es')?'GPS Transporte â€” La Paz':'GPS Transport â€” La Paz'; }); }
Â  Â  Â  const loginBackdrop = document.getElementById('loginBackdrop');
Â  Â  Â  const btnLogin = document.getElementById('btnLogin');
Â  Â  Â  const btnCloseLogin = document.getElementById('btnCloseLogin');
Â  Â  Â  const btnDoLogin = document.getElementById('btnDoLogin');
Â  Â  Â  if(btnLogin && loginBackdrop) btnLogin.addEventListener('click', ()=> loginBackdrop.style.display='flex');
Â  Â  Â  if(btnCloseLogin) btnCloseLogin.addEventListener('click', ()=> loginBackdrop.style.display='none');
Â  Â  Â  const guideBackdrop = document.getElementById('guideBackdrop');
Â  Â  Â  const btnGuide = document.getElementById('btnGuide');
Â  Â  Â  const btnCloseGuide = document.getElementById('btnCloseGuide');
Â  Â  Â  if(btnGuide && guideBackdrop) btnGuide.addEventListener('click', ()=> guideBackdrop.style.display='flex');
Â  Â  Â  if(btnCloseGuide) btnCloseGuide.addEventListener('click', ()=> guideBackdrop.style.display='none');
Â  Â  });
Â  </script>

</body>
</html>