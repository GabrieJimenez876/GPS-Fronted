
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ver Rutas ‚Äî GPS Transporte La Paz</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous"/>
  
  <style>
    :root{ --c-primary:#004d40; --c-bg:#f6f7f8; --c-fg:#1f2937; --c-panel:#ffffff; --c-border:#e5e7eb; --radius:12px; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--c-bg);color:var(--c-fg)}
    header{position:sticky;top:0;z-index:20;background:var(--c-primary);color:#fff}
    .header-inner{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:36px;height:36px;border-radius:50%;background:#00a58c;display:grid;place-items:center;font-weight:700}
    .brand h1{font-size:18px;margin:0}
    nav{flex:1;display:flex;justify-content:center}
    .menu{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{height:42px;padding:0 14px;border:1px solid #9ee7db;border-radius:8px;background:#e6fffa;color:#083b35;cursor:pointer}
    .btn.primary{background:#00a58c;color:#fff;border-color:#00a58c}
    .menu-item{position:relative}
    .dropdown{position:absolute;top:calc(100% + 6px);left:0;min-width:240px;background:#fff;border:1px solid var(--c-border);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.08);display:none;padding:6px;z-index:30}
    .dropdown a{display:block;padding:10px 12px;border-radius:8px;color:#111;text-decoration:none}
    .dropdown a:hover{background:#f3f4f6}
    .menu-item:hover .dropdown{display:block}
    .profile-area{display:flex;align-items:center;gap:10px}
    .container{max-width:1200px;margin:0 auto;padding:14px;display:grid;gap:14px}
    .panel{background:var(--c-panel);border:1px solid var(--c-border);border-radius:var(--radius);box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .panel header{padding:12px 14px;border-bottom:1px solid var(--c-border)}
    .panel .content{padding:12px 14px}
    footer{background:var(--c-primary);color:#fff;margin-top:14px}
    .footer-inner{max-width:1200px;margin:0 auto;padding:14px;display:grid;gap:10px}
    .socials{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .socials a{display:inline-flex;align-items:center;gap:6px;background:#00695c;color:#fff;text-decoration:none;padding:4px 8px;border-radius:8px}
    .socials svg{width:16px;height:16px;fill:#fff}
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:min(520px,92vw);background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .modal header{background:#00a58c;color:#fff;padding:12px 16px}
    .modal .content{padding:16px;display:grid;gap:10px}
    .modal .footer{padding:12px 16px;display:flex;justify-content:flex-end;gap:10px;border-top:1px solid #eee}
    input[type="text"],input[type="email"],input[type="password"]{height:42px;padding:0 12px;border:1px solid var(--c-border);border-radius:8px}
    .dark body{background:#121212;color:#e6e6e6}
  </style>

  <style>
    /* UI z-index fixes so header/buttons and side panels float above leaflet map */
    .header-inner, .menu, .menu .btn, .profile-area, .dropdown, .panel { position: relative; z-index: 1100; }
    .dropdown { z-index: 1110; }
    #map { position: relative; z-index: 0; }
    .backdrop, .modal-backdrop { z-index: 1200; }

    .page{max-width:1200px;margin:0 auto;padding:14px;display:grid;grid-template-columns:360px 1fr;gap:14px}
    #map{height:70vh;min-height:520px;border-radius:12px;border:1px solid var(--c-border);overflow:hidden}
    .route-header{display:flex;flex-direction:column;gap:6px}
    .route-title{font-weight:700;font-size:18px;margin:0}
    .route-meta{color:#374151;font-size:13px}
    .stop-list{list-style:none;margin:10px 0 0 0;padding:0;display:grid;gap:8px;max-height:calc(100vh - 260px);overflow:auto}
    .stop-item{display:flex;align-items:center;gap:10px;padding:8px;border:1px solid var(--c-border);border-radius:10px;background:#fafafa}
    .stop-badge{min-width:26px;height:26px;border-radius:50%;display:grid;place-items:center;font-weight:700;font-size:13px;color:#fff;background:#6b7280}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border:1px solid #ddd;padding:8px;font-size:14px}
    .table th{background:var(--c-primary);color:#fff;text-align:left}
    @media (max-width:980px){ .page{grid-template-columns:1fr} #map{height:60vh} }
  </style>
  <style>
    /* nav compatibility for index-like header */
    .nav-row { display:flex; gap:8px; align-items:center; width:100%; }
    .nav-left { display:flex; gap:8px; align-items:center; }
    .nav-right { margin-left:auto; display:flex; gap:8px; }
    .nav-btn{ height:42px; padding:0 12px; display:inline-flex; gap:8px; align-items:center; border-radius:8px; background:rgba(255,255,255,0.95); color:var(--c-primary); border:1px solid rgba(255,255,255,0.08); cursor:pointer; font-size:14px; }
    .nav-btn.primary{ background:var(--c-primary); color:#fff; border-color:var(--c-primary); }
    .nav-btn .fa{ font-size:16px; }
  </style>
 <script>
    // Seed example routes into localStorage: prefer server file `data/lineas.json`, fallback to inline R201
    (async function(){
      try{
        const key = 'gps_routes';
        const current = JSON.parse(localStorage.getItem(key) || '[]');

        // inline fallback route (kept for offline preview)
        const route201 = {
          id: 201,
          key: 'R201',
          name: 'L√≠nea 201 ‚Äî Avenida Apumalla ‚áÑ Calle 14 de Septiembre',
          operator: 'Sindicato 14 de Septiembre',
          vehicle: 'Microbus N¬∞ 201',
          color: '#1e88e5',
          stops: [
            { name: 'Avenida Apumalla 1055', lat: -16.494907, lng: -68.145221 },
            { name: 'J.M. Asin 593', lat: -16.495810, lng: -68.144012 },
            { name: 'J.M. Asin 420', lat: -16.496502, lng: -68.143401 },
            { name: 'Quintanilla Zuazo', lat: -16.499201, lng: -68.140900 },
            { name: 'Av. Rep√∫blica', lat: -16.500800, lng: -68.137900 },
            { name: 'Av. Per√∫', lat: -16.503410, lng: -68.132900 },
            { name: 'Av. Ismael Montes', lat: -16.505312, lng: -68.130410 },
            { name: 'Av. Mariscal Santa Cruz', lat: -16.508811, lng: -68.131099 },
            { name: 'Av. 16 de Julio', lat: -16.510800, lng: -68.128300 },
            { name: 'Landaeta', lat: -16.512700, lng: -68.125709 },
            { name: 'S√°nchez Lima', lat: -16.515900, lng: -68.122900 },
            { name: 'Obrajes', lat: -16.522999, lng: -68.110100 },
            { name: 'Av. Hernando Siles', lat: -16.533400, lng: -68.108900 },
            { name: 'San Miguel', lat: -16.541001, lng: -68.086900 },
            { name: 'Calle 25 Arturo Fort√∫n', lat: -16.549808, lng: -68.073000 },
            { name: 'Calle 38 La Loma', lat: -16.554901, lng: -68.067700 },
            { name: 'H√©roes del Chaco', lat: -16.560702, lng: -68.061900 },
            { name: 'Calle 14 de Septiembre 150', lat: -16.563700, lng: -68.058400 }
          ],
          path: [
            [-16.494907, -68.145221],[-16.495810, -68.144012],[-16.496502, -68.143401],[-16.499201, -68.140900],
            [-16.500800, -68.137900],[-16.503410, -68.132900],[-16.505312, -68.130410],[-16.508811, -68.131099],
            [-16.510800, -68.128300],[-16.512700, -68.125709],[-16.515900, -68.122900],[-16.522999, -68.110100],
            [-16.533400, -68.108900],[-16.541001, -68.086900],[-16.549808, -68.073000],[-16.554901, -68.067700],
            [-16.560702, -68.061900],[-16.563700, -68.058400]
          ]
        };

        // Try loading server-side routes file
        let sample = [];
        try{
          const resp = await fetch('/data/lineas.json');
          if(resp.ok){
            const data = await resp.json();
            if(Array.isArray(data) && data.length){
              sample = data.map(r => ({
                id: r.id,
                key: r.codigo && r.codigo.trim() !== '' ? r.codigo : ('R' + String(r.id)),
                name: r.nombre || r.name || '',
                operator: r.sindicato || r.operator || '',
                vehicle: r.vehiculo || r.vehicle || '',
                color: '#1e88e5',
                stops: Array.isArray(r.paradas) ? r.paradas.map((p, i) => ({ name: p.nombre||p.name||`Parada ${i+1}`, lat: parseFloat(p.lat||p.latitude||p.latitud||0), lng: parseFloat(p.lng||p.longitude||p.lon||0) })) : [],
                path: Array.isArray(r.paradas) ? r.paradas.map(p => [parseFloat(p.lat||p.latitude||p.latitud||0), parseFloat(p.lng||p.longitude||p.lon||0)]) : []
              }));
            }
          }
        }catch(err){ /* ignore fetch errors, fallback below */ }

        if(!sample.length){ sample = [ route201 ]; }

        const needsWrite = !Array.isArray(current) || current.length === 0 || !current.find(r => r.key === 'R201') || sample.some(s => s.key && !current.find(c => c.key === s.key));
        if(needsWrite){ localStorage.setItem(key, JSON.stringify(sample)); }

      }catch(e){ console.warn('no se pudo seed routes', e); }
    })();
¬† </script>
</head>
<body>
  <header>
    <div class="header-inner">
      <!-- Brand -->
      <div class="brand">
        <div class="logo" aria-hidden="true">LP</div>
        <div>
          <h1 id="appTitle">GPS Transporte ‚Äî La Paz</h1>
          <div style="font-size:12px; opacity:.9">Centro de transporte comunitario</div>
        </div>
      </div>

      <!-- Navigation -->
      <nav class="nav-row">
        <div class="nav-left">
          <div class="menu-item">
            <button class="nav-btn" id="btnRoutes">
              <i class="fa fa-location-dot"></i>
              <span>Rutas</span>
            </button>
            <div class="dropdown">
              <a href="rutas/linea-1.html">L√≠nea 1 ‚Äî Villa F√°tima ‚áÑ Miraflores</a>
              <a href="rutas/linea-2.html">L√≠nea 2 ‚Äî Ceja ‚áÑ Cementerio</a>
              <a href="rutas/linea-3.html">L√≠nea 3 ‚Äî Terminal ‚áÑ Telef√©rico Central</a>
              <a href="ver_rutas.html"><strong>Ver todas las rutas ‚Üí</strong></a>
            </div>
          </div>

          <button class="nav-btn" id="btnGuide">
            <i class="fa fa-book"></i>
            <span>Gu√≠a</span>
          </button>
          
          <button class="nav-btn" id="btnDark">
            <i class="fa fa-moon"></i>
            <span>Modo</span>
          </button>
          
          <button class="nav-btn" id="btnLang">
            <i class="fa fa-language"></i>
            <span>English</span>
          </button>
        </div>

        <div class="nav-right">
          <!-- Admin button (hidden by default) -->
          <div class="menu-item" id="adminSection" style="display:none">
            <button class="nav-btn">
              <i class="fa fa-wrench"></i>
              <span>Admin</span>
            </button>
            <div class="dropdown">
              <a href="agregar_linea.html">‚ûï Agregar l√≠nea</a>
              <a href="base_datos.html">üìÑ Ver base de datos</a>
              <a href="sindicatos.html">ü§ù Sindicatos</a>
            </div>
          </div>

          <div id="userArea">
            <!-- visible when no session -->
            <button class="nav-btn" id="btnRegister">
              <i class="fa fa-user-plus"></i>
              <span>Registrarse</span>
            </button>

            <button class="nav-btn primary" id="btnLogin">
              <i class="fa fa-user"></i>
              <span>Iniciar sesi√≥n</span>
            </button>

            <!-- profile pill (hidden by default) -->
            <div class="menu-item profile-wrap" id="profileWrap" style="display:none;">
              <button class="nav-btn" id="btnProfile">
                <span id="profileAvatar" style="display:inline-grid;place-items:center;width:30px;height:30px;border-radius:50%;background:#fff;color:var(--primary);font-weight:600;margin-right:8px;">A</span>
                <div style="text-align:left;line-height:1;">
                  <div id="profileName" style="font-size:13px;color:#fff;font-weight:600">User</div>
                  <div id="profileEmail" style="font-size:11px;opacity:0.9;color:#eafaf7">email@example.com</div>
                </div>
              </button>
              <div class="dropdown" id="profileDropdown">
                <a href="#" id="btnSwitchUser">Cambiar usuario</a>
                <a href="#" id="btnLogout">Cerrar sesi√≥n</a>
              </div>
            </div>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main class="page">
    <aside class="panel" id="sidebar">
      <header>
        <div class="route-header">
          <h2 class="route-title" id="routeTitle">Selecciona una ruta</h2>
          <div class="route-meta" id="routeMeta">Operador ¬∑ Veh√≠culo ¬∑ Sentido</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
            <button class="btn" id="btnClear">üßπ Limpiar</button>
            <button class="btn" id="btnReverse" disabled>‚áÜ Alternar sentido</button>
            <button class="btn" id="btnFit" disabled>üîé Ajustar al mapa</button>
          </div>
        </div>
      </header>
      <div class="content">
        <h3 style="margin:0 0 6px 0;">Paradas</h3>
        <ul class="stop-list" id="stopList"><li class="stop-item" style="opacity:.7">No hay paradas cargadas.</li></ul>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px">
          <h3 style="margin:0 0 6px 0;">Rutas disponibles</h3>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table class="table" id="routesTable">
            <thead><tr><th style="width:48px">N¬∞</th><th>Operador</th><th>Veh√≠culo</th><th>Ruta</th><th style="width:140px">Acci√≥n</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </aside>
    <section class="panel" style="padding:10px">
      <div id="map"></div>
      <div class="content" style="background:var(--c-bg);border-radius:10px;margin-top:10px">
        <h3 style="margin:0 0 6px 0;">L√≠neas Cercanas (ejemplo)</h3>
        <ul style="margin:0;padding-left:18px"><li><strong>L√≠nea Amarilla:</strong> Cementerio ‚Üí Hospital Juan XXIII</li><li><strong>L√≠nea Verde:</strong> Cementerio ‚Üí Munaypata</li></ul>
      </div>
    </section>
  </main>
  
  <footer>
    <div class="footer-inner">
      <div>Contacto: <a href="mailto:lapazbus@lapaz.bo" style="color:#b2fff5">lapazbus@lapaz.bo</a> ‚Äî Tel: 2652444 / 61022444</div>
      <div class="socials" aria-label="redes sociales">
        <a href="#" title="Facebook" aria-label="Facebook">
          <svg viewBox="0 0 24 24"><path d="M22 12.07C22 6.48 17.52 2 11.93 2S2 6.48 2 12.07C2 17.08 5.66 21.2 10.44 22v-7.01H7.9v-2.92h2.54V9.84c0-2.5 1.49-3.89 3.77-3.89 1.09 0 2.24.2 2.24.2v2.47h-1.26c-1.24 0-1.63.77-1.63 1.56v1.87h2.78l-.44 2.92h-2.34V22C18.34 21.2 22 17.08 22 12.07z"></path></svg>
          <span>Facebook</span>
        </a>
        <a href="#" title="X/Twitter" aria-label="X/Twitter">
          <svg viewBox="0 0 24 24"><path d="M3 3h5.3l4.1 6.2L16.7 3H21l-7.2 10.2L21 21h-5.3l-4.2-6.1L7.3 21H3l7.8-10.8L3 3z"></path></svg>
          <span>Twitter</span>
        </a>
        <a href="#" title="Instagram" aria-label="Instagram">
          <svg viewBox="0 0 24 24"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm5 3.5A5.5 5.5 0 1 1 6.5 13 5.5 5.5 0 0 1 12 7.5zm6.75-1.5a1.25 1.25 0 1 1-1.25 1.25A1.25 1.25 0 0 1 18.75 6z"></path></svg>
          <span>Instagram</span>
        </a>
        <a href="#" title="Telegram" aria-label="Telegram">
          <svg viewBox="0 0 24 24"><path d="M9.04 15.47 8.8 19.7a.94.94 0 0 0 .73-.35l1.75-1.67 3.63 2.67c.67.37 1.15.18 1.33-.62l2.42-11.34c.21-.93-.34-1.3-1-1.07L3.95 11.1c-.9.35-.89.84-.16 1.07l3.6 1.12 8.38-5.29c.39-.24.75-.11.46.15l-7.19 6.32z"></path></svg>
          <span>Telegram</span>
        </a>
      </div>
    </div>
  </footer>

  
  <div class="backdrop" id="loginBackdrop" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="modal">
      <header><h3 id="loginTitle" style="margin:0">Iniciar sesi√≥n</h3></header>
      <div class="content">
        <label for="email">Correo</label>
        <input type="email" id="email" placeholder="usuario@gmail.com"/>
        <label for="password">Contrase√±a</label>
        <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
      </div>
      <div class="footer">
        <button class="btn" id="btnCloseLogin">Cerrar</button>
        <button class="btn primary" id="btnDoLogin">Ingresar</button>
      </div>
    </div>
  </div>
  <div class="backdrop" id="guideBackdrop" role="dialog" aria-modal="true" aria-labelledby="guideTitle">
    <div class="modal">
      <header><h3 id="guideTitle" style="margin:0">Gu√≠a r√°pida</h3></header>
      <div class="content"><p>Explora las rutas, administra datos y consulta sindicatos.</p></div>
      <div class="footer"><button class="btn primary" id="btnCloseGuide">Entendido</button></div>
    </div>
  </div>

  <!-- Agregar Ruta Modal -->
  <div class="backdrop" id="addRouteBackdrop" role="dialog" aria-modal="true" aria-labelledby="addRouteTitle" style="display:none">
    <div class="modal">
      <header><h3 id="addRouteTitle" style="margin:0">Agregar nueva ruta</h3></header>
      <div class="content">
        <label for="routeName">Nombre de la ruta</label>
        <input type="text" id="routeName" placeholder="Ej: L√≠nea Amarilla" />
        <label for="routeOperator">Operador / Sindicato</label>
        <input type="text" id="routeOperator" placeholder="Ej: Sindicato Villa Victoria" />
        <label for="routeVehicle">Veh√≠culo</label>
        <input type="text" id="routeVehicle" placeholder="Ej: Minibus" />
        <label for="routeColor">Color (hex)</label>
        <input type="text" id="routeColor" placeholder="#f1c40f" />
        <label for="routeStops">Paradas (una por l√≠nea: nombre,lat,lng)</label>
        <textarea id="routeStops" rows="6" placeholder="Plaza Eguino,-16.493886,-68.140775\nCementerio,-16.49694,-68.15167"></textarea>
      </div>
      <div class="footer">
        <button class="btn" id="btnCloseAddRoute">Cancelar</button>
        <button class="btn primary" id="btnSaveRoute">Guardar y previsualizar</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const map = L.map('map').setView([-16.5, -68.15], 13);
    const bounds = L.latLngBounds(L.latLng(-16.62,-68.24), L.latLng(-16.43,-68.02));
    map.setMaxBounds(bounds); map.on('drag', ()=> map.panInsideBounds(bounds,{animate:false}));
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18, attribution:'¬© OpenStreetMap'}).addTo(map);
    const routeLayer = L.layerGroup().addTo(map);

    // Load routes from localStorage (key: 'gps_routes')
    function loadRoutesFromStorage(){
      try{ return JSON.parse(localStorage.getItem('gps_routes') || '[]'); }catch(e){ return []; }
    }

    const ROUTES_OBJ = (function(){
      const arr = loadRoutesFromStorage();
      const obj = {};
      arr.forEach(r=> obj[r.key] = r);
      return obj;
    })();

    const $ = s=>document.querySelector(s); const $$ = s=>Array.from(document.querySelectorAll(s)); 
    const stopList = $('#stopList'); const routeTitle = $('#routeTitle'); const routeMeta = $('#routeMeta');
    const btnReverse = $('#btnReverse'); const btnFit = $('#btnFit');
    let currentKey = null; let reversed = false;

    function renderRoutesTable(){
      const tbody = document.querySelector('#routesTable tbody'); tbody.innerHTML='';
      const arr = loadRoutesFromStorage();
      if(!arr.length) tbody.innerHTML = '<tr><td colspan="5">No hay rutas registradas.</td></tr>';
      arr.forEach((r, i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.id || (i+1)}</td><td>${r.operator || '‚Äî'}</td><td>${r.vehicle || '‚Äî'}</td><td>${r.name || r.key}</td><td><button class="btn" data-show="${r.key}">üëÅÔ∏è‚Äçüó® Ver ruta</button></td>`;
        tbody.appendChild(tr);
      });
      $$('button[data-show]').forEach(b=> b.addEventListener('click', ()=> showRoute(b.getAttribute('data-show'))));
      // After rendering the routes table, also populate sindicatos list in the sidebar
      renderSindicatos();
    }

    // Build and render sindicatos (group routes by operator) into the sidebar
    function renderSindicatos(){
      try{
        const sidebar = document.getElementById('sidebar');
        if(!sidebar) return;
        const existing = document.getElementById('sindicatosBlock'); if(existing) existing.remove();
        const block = document.createElement('div'); block.id='sindicatosBlock'; block.className='panel';
        block.style.marginBottom='12px';
        const header = document.createElement('header'); header.innerHTML = '<h3 style="margin:0">Sindicatos</h3>'; block.appendChild(header);
        const content = document.createElement('div'); content.className='content';
        const routes = loadRoutesFromStorage();
        const byOp = {};
        routes.forEach(r=>{ const op = (r.operator||r.operator||'Sin sindicato'); if(!byOp[op]) byOp[op]=[]; byOp[op].push(r); });
        Object.keys(byOp).forEach(op=>{
          const lines = byOp[op];
          const el = document.createElement('div'); el.className='list-item'; el.style.justifyContent='space-between';
          el.innerHTML = `<div><strong>${op}</strong><div style="font-size:13px;color:#666">${lines.length} l√≠nea(s)</div></div><div><button class="nav-btn" style="height:34px;padding:6px 10px" data-op="${op}">Ver</button></div>`;
          content.appendChild(el);
        });
        block.appendChild(content);
        sidebar.insertBefore(block, sidebar.firstChild);
        Array.from(block.querySelectorAll('button[data-op]')).forEach(btn=> btn.addEventListener('click', ()=>{
          const op = btn.getAttribute('data-op'); const routes = loadRoutesFromStorage().filter(r=> (r.operator||'')===op);
          if(routes.length) showRoute(routes[0].key || routes[0].key);
        }));
      }catch(e){ console.error('renderSindicatos error', e); }
    }

    function clearRoute(){
      routeLayer.clearLayers();
      stopList.innerHTML = '<li class="stop-item" style="opacity:.7">No hay paradas cargadas.</li>';
      routeTitle.textContent = 'Selecciona una ruta';
      routeMeta.textContent = 'Operador ¬∑ Veh√≠culo ¬∑ Sentido';
      currentKey = null; reversed = false; btnReverse.disabled = true; btnFit.disabled = true;
    }

    function fitToLayer(){
      const layers = routeLayer.getLayers(); if(!layers.length) return;
      const b = L.latLngBounds([]);
      layers.forEach(l=>{ if(l.getBounds) b.extend(l.getBounds()); else if(l.getLatLng) b.extend(l.getLatLng()); });
      if(b.isValid()) map.fitBounds(b.pad(0.15));
    }

    function showRoute(key){
      const data = ROUTES_OBJ[key] || loadRoutesFromStorage().find(r=>r.key===key);
      if(!data) { alert('Ruta no encontrada'); return; }
      currentKey = key; routeLayer.clearLayers();
      const path = reversed ? [...data.path].reverse() : data.path;
      // If path not provided, derive from stops
      const pathCoords = (data.path && data.path.length) ? ((reversed? [...data.path].reverse(): data.path)) : data.stops.map(s=>[s.lat,s.lng]);
      L.polyline(pathCoords, {color:data.color || '#2196f3', weight:5, opacity:0.9}).addTo(routeLayer);
      const list = reversed ? [...data.stops].reverse() : data.stops;
      stopList.innerHTML = '';
      list.forEach((s,idx)=>{
        const icon = L.divIcon({ className:'stop-icon', html:`<div class="stop-badge" style="background:${data.color};">${idx+1}</div>`, iconSize:[26,26], iconAnchor:[13,13] });
        L.marker([s.lat, s.lng], {icon}).addTo(routeLayer).bindPopup(`<b>${idx+1}. ${s.name}</b><br>${data.name}`);
        const li = document.createElement('li');
        li.className = 'stop-item'; li.innerHTML = `<span class="stop-badge" style="background:${data.color};">${idx+1}</span><span class="stop-name">${s.name}</span>`;
        li.addEventListener('click', ()=> map.setView([s.lat, s.lng], 15));
        stopList.appendChild(li);
      });
      routeTitle.textContent = data.name || data.key;
      routeMeta.textContent = `${data.operator || 'Operador desconocido'} ¬∑ ${data.vehicle || '‚Äî'} ¬∑ ${reversed ? 'Sentido B' : 'Sentido A'}`;
      btnReverse.disabled = false; btnFit.disabled = false; fitToLayer();
    }

    document.getElementById('btnClear').addEventListener('click', clearRoute);
    document.getElementById('btnFit').addEventListener('click', fitToLayer);
    document.getElementById('btnReverse').addEventListener('click', ()=>{ if(!currentKey) return; reversed=!reversed; showRoute(currentKey); });

    renderRoutesTable();

    const params = new URLSearchParams(location.hash.replace(/^#/, ''));
    if(params.get('route')) showRoute(params.get('route'));
  </script>
  
  <script>
    // Reusar el helper definido en el script anterior; evitar redeclarar const globales
    window.addEventListener('DOMContentLoaded', ()=>{
      const btnDark = document.getElementById('btnDark');
      if(btnDark) btnDark.addEventListener('click', ()=> document.documentElement.classList.toggle('dark'));
      const btnLang = document.getElementById('btnLang');
      if(btnLang){ let lang='es'; btnLang.addEventListener('click', ()=>{ lang=(lang==='es')?'en':'es'; btnLang.textContent=(lang==='es')?'üåê English':'üåê Espa√±ol'; const h1=document.querySelector('h1'); if(h1) h1.textContent=(lang==='es')?'GPS Transporte ‚Äî La Paz':'GPS Transport ‚Äî La Paz'; }); }
      const loginBackdrop = document.getElementById('loginBackdrop');
      const btnLogin = document.getElementById('btnLogin');
      const btnCloseLogin = document.getElementById('btnCloseLogin');
      const btnDoLogin = document.getElementById('btnDoLogin');
      if(btnLogin && loginBackdrop) btnLogin.addEventListener('click', ()=> loginBackdrop.style.display='flex');
      if(btnCloseLogin) btnCloseLogin.addEventListener('click', ()=> loginBackdrop.style.display='none');
      if(btnDoLogin) btnDoLogin.addEventListener('click', ()=>{ loginBackdrop.style.display='none'; /* demo login handled by shared helper */ });
      const guideBackdrop = document.getElementById('guideBackdrop');
      const btnGuide = document.getElementById('btnGuide');
      const btnCloseGuide = document.getElementById('btnCloseGuide');
      if(btnGuide && guideBackdrop) btnGuide.addEventListener('click', ()=> guideBackdrop.style.display='flex');
      if(btnCloseGuide) btnCloseGuide.addEventListener('click', ()=> guideBackdrop.style.display='none');
    });
  </script>

  <!-- Shared session / profile helper (keeps behavior similar to index.html) -->
  <script>
    (function(){
      const USERS_KEY = 'gps_users';
      const CURRENT_USER_KEY = 'gps_current_user';
      const ADMIN_EMAIL = 'admin@admin.com';
      const ADMIN_PASSWORD = 'admin123';

      function getUsers(){ try{ return JSON.parse(localStorage.getItem(USERS_KEY)||'[]'); }catch(e){return[]} }
      function saveUser(user){ const u=getUsers(); u.push(user); localStorage.setItem(USERS_KEY, JSON.stringify(u)); }
      function setCurrent(user){ localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(user)); updateUIForSession(user); }
      function getCurrent(){ try{ return JSON.parse(localStorage.getItem(CURRENT_USER_KEY)||'null'); }catch(e){return null} }

      function ensureProfileWrap(){ let wrap = document.getElementById('profileWrap'); if(!wrap){ const area = document.querySelector('.profile-area'); if(area){ wrap = document.createElement('div'); wrap.id='profileWrap'; area.appendChild(wrap); } } return wrap; }

      function updateUIForSession(session){ const wrap = ensureProfileWrap(); if(!wrap) return; wrap.innerHTML=''; if(!session){ wrap.innerHTML = '<button class="btn primary" id="btnLogin">üîê Iniciar sesi√≥n</button>'; const btnLogin = document.getElementById('btnLogin'); if(btnLogin) btnLogin.addEventListener('click', ()=> document.getElementById('loginBackdrop').style.display='flex'); }
        else { const isAdmin = session.role==='admin'; wrap.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div style="font-weight:700">${session.name||session.email}</div><div style="font-size:12px;color:#eef">${isAdmin? 'Administrador':'Usuario'}</div><button class="btn" id="btnLogout">Salir</button></div>`; const btnLogout = document.getElementById('btnLogout'); if(btnLogout) btnLogout.addEventListener('click', ()=>{ localStorage.removeItem(CURRENT_USER_KEY); updateUIForSession(null); }); }
      }

      // wire demo login button
      window.addEventListener('DOMContentLoaded', ()=>{
        const btnDoLogin = document.getElementById('btnDoLogin');
        if(btnDoLogin){ btnDoLogin.addEventListener('click', ()=>{
          const email = (document.getElementById('email')||{}).value || 'user@example.com';
          const pass = (document.getElementById('password')||{}).value || '';
          if(email === ADMIN_EMAIL && pass === ADMIN_PASSWORD){ const admin = { name:'Administrador', email:ADMIN_EMAIL, role:'admin'}; setCurrent(admin); alert('Sesi√≥n iniciada: Admin'); }
          else { const user = { name: email.split('@')[0], email, role:'user'}; setCurrent(user); alert('Sesi√≥n iniciada: ' + user.name); }
          document.getElementById('loginBackdrop').style.display='none';
        }); }
        // initialize UI from storage
        updateUIForSession(getCurrent());
      });
    })();
  </script>

</body>
</html>