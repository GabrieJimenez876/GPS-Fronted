<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GPS Transporte ‚Äî La Paz</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Icon set (Font Awesome) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="" crossorigin="anonymous"/>

  <style>
    /* Theme variables: central place to tune colors & sizes */
    :root{
      --bg:#f4f4f4;
      --fg:#222;
      --primary:#00695c;
      --surface:#ffffff;
      --muted:#e0f2f1;
      --border:#d9d9d9;
      --radius:10px;
      --shadow:0 6px 18px rgba(0,0,0,.08);

      /* icon / button sizing */
      --icon-size:18px;
      --btn-h:44px;
      --btn-fz:15px;
      --map-height:520px;
      --max-width:1100px;
    }

    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:var(--bg); color:var(--fg);}

    header{ background:var(--primary); color:#fff; box-shadow:var(--shadow); position:sticky; top:0; z-index:1000;}
    .header-inner{ max-width:var(--max-width); margin:0 auto; display:flex; gap:12px; align-items:center; padding:12px; justify-content:space-between; flex-wrap:wrap;}
    .brand{ display:flex; align-items:center; gap:12px;}
    .brand .logo{ width:44px; height:44px; border-radius:10px; background:#004d40; display:grid; place-items:center; font-weight:700; color:#fff; }
    .brand h1{ margin:0; font-size:18px; }

    nav{ display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .nav-btn{ height:var(--btn-h); padding:0 12px; display:inline-flex; gap:8px; align-items:center; border-radius:8px; background:#fff; color:var(--primary); border:1px solid #cfece6; cursor:pointer; font-size:var(--btn-fz); }
    .nav-btn.primary{ background:var(--primary); color:#fff; border:1px solid var(--primary); }
    .nav-btn .fa { font-size:var(--icon-size); line-height:1; }

    /* dropdown */
    .menu-item{ position:relative; }
    .dropdown{ position:absolute; top:calc(100% + 8px); left:0; background:var(--surface); border:1px solid var(--border); border-radius:8px; box-shadow:var(--shadow); min-width:220px; display:none; z-index:30;}
    .dropdown a{ display:block; padding:10px 12px; color:var(--fg); text-decoration:none; }
    .menu-item:hover .dropdown{ display:block; }

    /* main layout */
    main{ max-width:var(--max-width); margin:16px auto; padding:0 12px; }
    .grid{ display:grid; gap:12px; grid-template-columns: 1fr; }
    @media(min-width: 880px){ .grid{ grid-template-columns: 360px 1fr; } }

    .panel{ background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); }
    .map-box{ height:var(--map-height); border-radius:8px; overflow:hidden; border:1px solid var(--border); }

    .input-row{ display:flex; gap:10px; align-items:center; }
    .input-row input[type="text"]{ flex:1; height:var(--btn-h); padding:0 12px; border-radius:8px; border:1px solid var(--border); font-size:15px; }

    .button-row{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .btn-lg{ height:50px; padding:0 14px; border-radius:8px; background:var(--primary); color:#fff; border:none; font-size:15px; cursor:pointer; display:inline-flex; gap:8px; align-items:center;}
    .btn-outline{ background:#fff; color:var(--primary); border:1px solid #cfece6; }

    .results{ margin-top:10px; background:var(--muted); padding:10px; border-radius:8px; border:1px solid #b2dfdb; font-size:14px; }

    /* Footer */
    footer{ margin-top:18px; padding:12px 0; background:transparent; color:var(--fg); }
    .footer-inner{ max-width:var(--max-width); margin:0 auto; padding:0 12px; display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; }

    /* modal simple */
    .modal-backdrop{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:1001; }
    .modal{ width:min(560px,92vw); background:#fff; border-radius:10px; overflow:hidden; }

    /* compact icon sizing for sidebar items */
    .list-item{ display:flex; gap:10px; align-items:center; padding:8px; border-radius:8px; cursor:default; }
    .list-item .fa{ width:24px; text-align:center; color:var(--primary); }

    /* dark mode */
    .dark-mode{ --bg:#121212; --fg:#e6e6e6; --surface:#1b1b1b; --muted:#242424; --border:#2b2b2b; --primary:#0aa089; }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true">LP</div>
        <h1 id="appTitle">GPS Transporte ‚Äî La Paz</h1>
      </div>

      <nav>
        <div class="menu">
          <div class="menu-item">
            <button class="nav-btn" id="btnRoutes"><i class="fa fa-location-dot"></i><span class="label">Rutas</span></button>
            <div class="dropdown" aria-label="submenu rutas">
              <a href="rutas/linea-1.html">L√≠nea 1 ‚Äî Villa F√°tima ‚áÑ Miraflores</a>
              <a href="rutas/linea-2.html">L√≠nea 2 ‚Äî Ceja ‚áÑ Cementerio</a>
              <a href="rutas/linea-3.html">L√≠nea 3 ‚Äî Terminal ‚áÑ Telef√©rico Central</a>
              <a href="ver_rutas.html"><strong>Ver todas las rutas ‚Üí</strong></a>
            </div>
          </div>

          <button class="nav-btn" id="btnGuide"><i class="fa fa-book"></i><span class="label">Gu√≠a</span></button>
          <button class="nav-btn" id="btnDark"><i class="fa fa-moon"></i><span class="label">Modo</span></button>
          <button class="nav-btn" id="btnLang"><i class="fa fa-language"></i><span class="label">English</span></button>

          <div class="menu-item">
            <button class="nav-btn"><i class="fa fa-wrench"></i><span class="label">Admin</span></button>
            <div class="dropdown" aria-label="submenu admin">
              <a href="agregar_linea.html">‚ûï Agregar l√≠nea</a>
              <a href="base_datos.html">üìÑ Ver base de datos</a>
              <a href="sindicatos.html">ü§ù Sindicatos</a>
            </div>
          </div>
        </div>
      </nav>

      <div id="profileArea">
        <button class="nav-btn primary" id="btnLogin"><i class="fa fa-user-lock"></i><span class="label">Iniciar sesi√≥n</span></button>
      </div>
    </div>
  </header>

  <main>
    <div class="grid">
      <section class="panel">
        <h2>Destino</h2>

        <div class="input-row" style="margin-top:8px;">
          <label for="dest" style="min-width:86px">Destino:</label>
          <input id="dest" type="text" placeholder="Ej: Plaza Murillo" />
        </div>

        <div class="button-row">
          <button class="nav-btn btn-outline" id="btnMyLoc"><i class="fa fa-location-crosshairs"></i> Mi ubicaci√≥n</button>
          <button class="btn-lg" id="btnMarkDest"><i class="fa fa-map-pin"></i> Marcar destino</button>
          <button class="nav-btn btn-outline" id="btnFindRoutes"><i class="fa fa-route"></i> Rutas</button>
        </div>

        <div id="results" class="results">Escribe un destino y usa los botones para marcar.</div>

        <hr aria-hidden="true" style="margin:12px 0; border:none; height:1px; background:#eee;" />

        <div>
          <h3 style="margin:6px 0 8px 0">Lugares r√°pidos</h3>
          <div class="list-item" onclick="quickPlace('plaza murillo')"><i class="fa fa-square-check"></i><span>Plaza Murillo</span></div>
          <div class="list-item" onclick="quickPlace('miraflores')"><i class="fa fa-square-check"></i><span>Miraflores</span></div>
          <div class="list-item" onclick="quickPlace('terminal')"><i class="fa fa-square-check"></i><span>Terminal</span></div>
        </div>
      </section>

      <section class="panel">
        <div id="map" class="map-box" role="application" aria-label="Mapa"></div>
      </section>
    </div>
  </main>

  <footer>
    <div class="footer-inner">
      <div>Contacto: lapazbus@lapaz.bo ‚Äî Tel: 2652444 / 61022444</div>
      <div>Mapa: Leaflet + OpenStreetMap</div>
    </div>
  </footer>

  <!-- Leaflet + optional Dart / app hooks -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    /* Small, tidy map & UI script. Keep adjustments centralized. */
    const map = L.map('map', { zoomControl:true }).setView([-16.5, -68.15], 13);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18, attribution: '¬© OpenStreetMap' }).addTo(map);

    const lpBounds = L.latLngBounds([-16.62, -68.24], [-16.43, -68.02]);
    map.setMaxBounds(lpBounds);
    map.on('drag', () => map.panInsideBounds(lpBounds, { animate:false }));

    let userMarker = L.marker([-16.5, -68.15]).addTo(map).bindPopup("Tu ubicaci√≥n");
    let destMarker = null;
    let lastClicked = null;
    map.on('click', e => lastClicked = e.latlng);

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const results = $('#results');

    // small common places table (use project JSON for larger set)
    const commonPlaces = {
      "plaza murillo": [-16.5, -68.15],
      "miraflores": [-16.509, -68.119],
      "terminal": [-16.495, -68.150],
      "ceja": [-16.495, -68.195],
      "cementerio": [-16.51, -68.150],
      "teleferico central": [-16.5, -68.135]
    };

    function markDestinationByName(name){
      let coords = null;
      if(name){
        const key = name.trim().toLowerCase();
        if(commonPlaces[key]) coords = commonPlaces[key];
      }
      if(!coords && lastClicked) coords = [lastClicked.lat, lastClicked.lng];
      if(!coords) coords = [-16.5, -68.15];
      if(destMarker) map.removeLayer(destMarker);
      destMarker = L.marker(coords).addTo(map).bindPopup("Destino: " + (name || "Sin nombre")).openPopup();
      map.setView(coords, 14);
      results.textContent = `Destino marcado (${coords[0].toFixed(5)}, ${coords[1].toFixed(5)})`;
    }

    $('#btnMarkDest').addEventListener('click', ()=> markDestinationByName($('#dest').value));
    $('#btnMyLoc').addEventListener('click', ()=>{
      if(!navigator.geolocation){ results.textContent = 'Geolocalizaci√≥n no disponible.'; return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        const { latitude, longitude } = pos.coords;
        const latlng = L.latLng(latitude, longitude);
        if(!lpBounds.contains(latlng)){ results.textContent = 'Tu ubicaci√≥n est√° fuera de La Paz.'; return; }
        if(userMarker) map.removeLayer(userMarker);
        userMarker = L.marker(latlng).addTo(map).bindPopup("Tu ubicaci√≥n").openPopup();
        map.setView(latlng, 14);
        results.textContent = `Ubicaci√≥n establecida (${latitude.toFixed(5)}, ${longitude.toFixed(5)})`;
      }, err=>{
        results.textContent = 'No se pudo obtener la ubicaci√≥n.';
      }, { enableHighAccuracy:true, timeout:8000});
    });

    $('#btnFindRoutes').addEventListener('click', ()=>{
      const u = userMarker ? userMarker.getLatLng() : null;
      const d = destMarker ? destMarker.getLatLng() : null;
      if(!u || !d){ results.textContent = 'Marca tu ubicaci√≥n y un destino para buscar rutas.'; return; }
      results.innerHTML = `<strong>Rutas</strong><br>Desde: ${u.lat.toFixed(5)}, ${u.lng.toFixed(5)}<br>Hasta: ${d.lat.toFixed(5)}, ${d.lng.toFixed(5)}<br><em>Conectando al backend...</em>`;
      // TODO: fetch routes from project API or local JSON
    });

    function quickPlace(key){ $('#dest').value = key; markDestinationByName(key); }

    // dark mode
    $('#btnDark').addEventListener('click', ()=> document.body.classList.toggle('dark-mode'));

    // language toggle: label swapping (kept minimal)
    let currentLang = 'es';
    $('#btnLang').addEventListener('click', ()=>{
      currentLang = currentLang === 'es' ? 'en' : 'es';
      // small set; extend using project i18n JSON
      const labels = {
        es: { routes:'Rutas', guide:'Gu√≠a', login:'Iniciar sesi√≥n', myloc:'Mi ubicaci√≥n', mark:'Marcar destino' },
        en: { routes:'Routes', guide:'Guide', login:'Sign in', myloc:'My location', mark:'Mark destination' }
      };
      $('#btnRoutes .label').textContent = labels[currentLang].routes;
      $('#btnGuide .label').textContent = labels[currentLang].guide;
      $('#btnLogin .label').textContent = labels[currentLang].login;
      $('#btnMyLoc').innerHTML = `<i class="fa fa-location-crosshairs"></i> ${labels[currentLang].myloc}`;
      $('#btnMarkDest').innerHTML = `<i class="fa fa-map-pin"></i> ${labels[currentLang].mark}`;
      $('#appTitle').textContent = currentLang==='es' ? 'GPS Transporte ‚Äî La Paz' : 'GPS Transport ‚Äî La Paz';
    });

    // Attempt to load project JSON config (place config.json in same folder)
    (async function loadConfig(){
      try{
        const res = await fetch('config.json');
        if(!res.ok) return;
        const cfg = await res.json();
        // Example: apply primary color from config.json if present
        if(cfg && cfg.theme && cfg.theme.primary){
          document.documentElement.style.setProperty('--primary', cfg.theme.primary);
        }
        // load places list if provided
        if(cfg && cfg.places){
          Object.assign(commonPlaces, cfg.places);
        }
      }catch(e){}
    })();

    // Optionally load compiled Dart/Flutter web app if present (drop compiled main.dart.js in this folder)
    (function tryLoadDart(){
      const dartScriptPath = 'main.dart.js';
      fetch(dartScriptPath, { method:'HEAD' }).then(r=>{
        if(r.ok){
          const s = document.createElement('script');
          s.src = dartScriptPath;
          s.defer = true;
          document.body.appendChild(s);
        }
      }).catch(()=>{ /* no dart build present */ });
    })();
  </script>
</body>
</html>